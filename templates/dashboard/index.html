{% extends 'base.html' %}

{% block title %}Dashboard - MotoCare{% endblock %}

{% block content %}
<!-- Header do Dashboard -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-1">
                    <i class="fas fa-tachometer-alt text-primary me-2"></i>
                    Dashboard
                </h1>
                <p class="text-muted mb-0">Bem-vindo de volta, {{ user.first_name|default:user.username }}!</p>
            </div>
            <div>
                <button class="btn btn-primary btn-lg" onclick="window.location.href='{% url 'motos:criar' %}'">
                    <i class="fas fa-plus me-2"></i>Adicionar Moto
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Cards de Métricas -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card h-100 border-0 shadow-sm">
            <div class="card-body text-center p-4">
                <div class="d-flex align-items-center justify-content-center mb-3">
                    <div class="rounded-circle bg-primary bg-opacity-10 p-3 me-3">
                        <i class="fas fa-motorcycle fa-2x text-primary"></i>
                    </div>
                    <div class="text-start">
                        <h2 class="mb-0 fw-bold text-primary" id="total-motos">{{ total_motos }}</h2>
                        <small class="text-muted">Total de Motos</small>
                    </div>
                </div>
                <div class="progress" style="height: 6px;">
                    <div class="progress-bar bg-primary" role="progressbar" style="width: 100%"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-3">
        <div class="card h-100 border-0 shadow-sm">
            <div class="card-body text-center p-4">
                <div class="d-flex align-items-center justify-content-center mb-3">
                    <div class="rounded-circle bg-success bg-opacity-10 p-3 me-3">
                        <i class="fas fa-wrench fa-2x text-success"></i>
                    </div>
                    <div class="text-start">
                        <h2 class="mb-0 fw-bold text-success" id="manutencoes-mes">0</h2>
                        <small class="text-muted">Manutenções</small>
                    </div>
                </div>
                <div class="progress" style="height: 6px;">
                    <div class="progress-bar bg-success" role="progressbar" style="width: 75%"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-3">
        <div class="card h-100 border-0 shadow-sm">
            <div class="card-body text-center p-4">
                <div class="d-flex align-items-center justify-content-center mb-3">
                    <div class="rounded-circle bg-warning bg-opacity-10 p-3 me-3">
                        <i class="fas fa-dollar-sign fa-2x text-warning"></i>
                    </div>
                    <div class="text-start">
                        <h2 class="mb-0 fw-bold text-warning" id="total-gasto">R$ 0,00</h2>
                        <small class="text-muted">Total Gasto</small>
                    </div>
                </div>
                <div class="progress" style="height: 6px;">
                    <div class="progress-bar bg-warning" role="progressbar" style="width: 60%"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-3">
        <div class="card h-100 border-0 shadow-sm">
            <div class="card-body text-center p-4">
                <div class="d-flex align-items-center justify-content-center mb-3">
                    <div class="rounded-circle bg-info bg-opacity-10 p-3 me-3">
                        <i class="fas fa-tachometer-alt fa-2x text-info"></i>
                    </div>
                    <div class="text-start">
                        <h2 class="mb-0 fw-bold text-info" id="km-medio">R$ 0,00</h2>
                        <small class="text-muted">Custo/km</small>
                    </div>
                </div>
                <div class="progress" style="height: 6px;">
                    <div class="progress-bar bg-info" role="progressbar" style="width: 45%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Moto Principal -->
{% if moto_principal %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-gradient-primary text-white">
                <div class="d-flex align-items-center">
                    <i class="fas fa-star me-2"></i>
                    <h5 class="mb-0">Moto Principal</h5>
                    <span class="badge bg-light text-primary ms-2">Favorita</span>
                </div>
            </div>
            <div class="card-body p-4">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h4 class="mb-3">
                            <i class="fas fa-motorcycle text-primary me-2"></i>
                            {{ moto_principal.marca }} {{ moto_principal.modelo }}
                        </h4>
                        <div class="row g-3">
                            <div class="col-md-3">
                                <div class="p-3 bg-light rounded">
                                    <small class="text-muted d-block">Ano</small>
                                    <strong class="h5 text-primary">{{ moto_principal.ano }}</strong>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="p-3 bg-light rounded">
                                    <small class="text-muted d-block">KM Atual</small>
                                    <strong class="h5 text-success">{{ moto_principal.km_atual|floatformat:0 }}</strong>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="p-3 bg-light rounded">
                                    <small class="text-muted d-block">KM Percorridos</small>
                                    <strong class="h5 text-info">{{ moto_principal.km_total_percorridos|floatformat:0 }}</strong>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="p-3 bg-light rounded">
                                    <small class="text-muted d-block">Idade</small>
                                    <strong class="h5 text-warning">{{ moto_principal.idade_anos }} anos</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 text-center">
                        <div class="d-grid gap-2">
                            <a href="{% url 'motos:detalhe' moto_principal.id %}" class="btn btn-outline-primary">
                                <i class="fas fa-eye me-2"></i>Ver Detalhes
                            </a>
                            <a href="{% url 'motos:editar' moto_principal.id %}" class="btn btn-outline-secondary">
                                <i class="fas fa-edit me-2"></i>Editar
                            </a>
                            <a href="{% url 'motos:perfil' moto_principal.id %}" class="btn btn-outline-info">
                                <i class="fas fa-user-cog me-2"></i>Perfil
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% else %}
<!-- Sem motos cadastradas -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm bg-gradient-primary text-white">
            <div class="card-body text-center py-5">
                <div class="mb-4">
                    <i class="fas fa-motorcycle fa-5x opacity-50"></i>
                </div>
                <h3 class="mb-3">Nenhuma moto cadastrada</h3>
                <p class="mb-4 opacity-75">Comece cadastrando sua primeira motocicleta para acompanhar suas manutenções.</p>
                <a href="{% url 'motos:criar' %}" class="btn btn-light btn-lg shadow">
                    <i class="fas fa-plus me-2"></i>Cadastrar Primeira Moto
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Ações Rápidas -->
<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light">
                <div class="d-flex align-items-center">
                    <i class="fas fa-rocket text-primary me-2"></i>
                    <h5 class="mb-0">Ações Rápidas</h5>
                </div>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3 col-sm-6">
                        <div class="card h-100 border-0 shadow-sm hover-lift">
                            <div class="card-body text-center p-4">
                                <div class="mb-3">
                                    <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                        <i class="fas fa-list fa-2x text-primary"></i>
                                    </div>
                                </div>
                                <h6 class="card-title mb-2">Ver Motos</h6>
                                <small class="text-muted">Gerenciar frota</small>
                                <a href="{% url 'motos:lista' %}" class="stretched-link"></a>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3 col-sm-6">
                        <div class="card h-100 border-0 shadow-sm hover-lift">
                            <div class="card-body text-center p-4">
                                <div class="mb-3">
                                    <div class="bg-success bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                        <i class="fas fa-wrench fa-2x text-success"></i>
                                    </div>
                                </div>
                                <h6 class="card-title mb-2">Manutenção</h6>
                                <small class="text-muted">Registrar serviço</small>
                                <a href="#" class="stretched-link"></a>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3 col-sm-6">
                        <div class="card h-100 border-0 shadow-sm hover-lift">
                            <div class="card-body text-center p-4">
                                <div class="mb-3">
                                    <div class="bg-info bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                        <i class="fas fa-brain fa-2x text-info"></i>
                                    </div>
                                </div>
                                <h6 class="card-title mb-2">Análise</h6>
                                <small class="text-muted">Diagnóstico inteligente</small>
                                <a href="#" class="stretched-link"></a>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3 col-sm-6">
                        <div class="card h-100 border-0 shadow-sm hover-lift">
                            <div class="card-body text-center p-4">
                                <div class="mb-3">
                                    <div class="bg-warning bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                        <i class="fas fa-chart-bar fa-2x text-warning"></i>
                                    </div>
                                </div>
                                <h6 class="card-title mb-2">Relatórios</h6>
                                <small class="text-muted">Análises detalhadas</small>
                                <a href="{% url 'dashboard:relatorios' %}" class="stretched-link"></a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Carregar dados do dashboard via API
document.addEventListener('DOMContentLoaded', function() {
    // Animações de entrada
    const cards = document.querySelectorAll('.card');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        setTimeout(() => {
            card.style.transition = 'all 0.5s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });

    // Carregar dados da API
    fetch('{% url "dashboard:api_data" %}')
        .then(response => response.json())
        .then(data => {
            atualizarMetricas(data);
        })
        .catch(error => console.error('Erro ao carregar dados:', error));
});

function atualizarMetricas(data) {
    if (data.metricas) {
        // Animação de contagem
        animateNumber('manutencoes-mes', data.metricas.total_manutencoes);
        animateNumber('total-gasto', data.metricas.total_gasto, 'R$ ');
        animateNumber('km-medio', data.metricas.media_km, 'R$ ');
    }
}

function animateNumber(elementId, targetValue, prefix = '') {
    const element = document.getElementById(elementId);
    if (!element) return;

    const startValue = 0;
    const duration = 1000;
    const startTime = performance.now();

    function update(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);

        const currentValue = startValue + (targetValue - startValue) * progress;

        if (typeof targetValue === 'number' && targetValue % 1 !== 0) {
            element.textContent = prefix + currentValue.toLocaleString('pt-BR', {minimumFractionDigits: 2});
        } else {
            element.textContent = prefix + Math.floor(currentValue);
        }

        if (progress < 1) {
            requestAnimationFrame(update);
        }
    }

    requestAnimationFrame(update);
}
</script>

<style>
.bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
}

.hover-lift {
    transition: all 0.3s ease;
}

.hover-lift:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15) !important;
}

.stretched-link {
    color: inherit;
}

.stretched-link:hover {
    color: inherit;
}

.progress {
    background-color: rgba(0, 0, 0, 0.1);
}

.card-header {
    border-bottom: none !important;
}

.rounded-circle {
    transition: all 0.3s ease;
}

.hover-lift:hover .rounded-circle {
    transform: scale(1.1);
}
</style>
{% endblock %}

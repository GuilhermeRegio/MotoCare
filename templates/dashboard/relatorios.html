{% extends 'base.html' %}

{% block title %}Relatórios - MotoCare{% endblock %}

{% block content %}
<!-- Header da Página -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-1">
                    <i class="fas fa-chart-bar text-primary me-2"></i>Relatórios
                </h1>
                <p class="text-muted mb-0">Análises detalhadas e relatórios da sua frota</p>
            </div>
            <div>
                <button class="btn btn-outline-primary me-2" onclick="window.print()">
                    <i class="fas fa-print me-2"></i>Imprimir
                </button>
                <button class="btn btn-outline-success" onclick="exportarPDF()">
                    <i class="fas fa-file-pdf me-2"></i>Exportar PDF
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Filtros Avançados -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light">
                <div class="d-flex align-items-center">
                    <i class="fas fa-filter text-primary me-2"></i>
                    <h5 class="mb-0">Filtros Avançados</h5>
                    <button class="btn btn-sm btn-outline-secondary ms-auto" type="button" data-bs-toggle="collapse" data-bs-target="#filtrosContent">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
            </div>
            <div class="collapse show" id="filtrosContent">
                <div class="card-body">
                    <form class="row g-3">
                        <div class="col-md-3">
                            <div class="form-floating">
                                <input type="date" class="form-control" id="data_inicio">
                                <label for="data_inicio">
                                    <i class="fas fa-calendar-alt me-1"></i>Data Inicial
                                </label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-floating">
                                <input type="date" class="form-control" id="data_fim">
                                <label for="data_fim">
                                    <i class="fas fa-calendar-alt me-1"></i>Data Final
                                </label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-floating">
                                <select class="form-select" id="moto">
                                    <option value="">Todas as motos</option>
                                    <option value="1">Dafra Cruisym 300</option>
                                </select>
                                <label for="moto">
                                    <i class="fas fa-motorcycle me-1"></i>Moto Específica
                                </label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-floating">
                                <select class="form-select" id="tipo_relatorio">
                                    <option value="geral">Relatório Geral</option>
                                    <option value="manutencoes">Manutenções</option>
                                    <option value="custos">Custos</option>
                                    <option value="performance">Performance</option>
                                </select>
                                <label for="tipo_relatorio">
                                    <i class="fas fa-chart-line me-1"></i>Tipo de Relatório
                                </label>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-primary" onclick="aplicarFiltros()">
                                    <i class="fas fa-search me-2"></i>Aplicar Filtros
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="limparFiltros()">
                                    <i class="fas fa-eraser me-2"></i>Limpar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Cards de Métricas -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card h-100 border-0 shadow-sm metric-card">
            <div class="card-body text-center p-4">
                <div class="metric-icon mb-3">
                    <i class="fas fa-wrench fa-3x text-primary"></i>
                </div>
                <h2 class="metric-value mb-2" id="total-manutencoes">0</h2>
                <p class="metric-label mb-0">Total de Manutenções</p>
                <small class="text-muted">Período selecionado</small>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-3">
        <div class="card h-100 border-0 shadow-sm metric-card">
            <div class="card-body text-center p-4">
                <div class="metric-icon mb-3">
                    <i class="fas fa-dollar-sign fa-3x text-success"></i>
                </div>
                <h2 class="metric-value mb-2" id="total-gasto">R$ 0,00</h2>
                <p class="metric-label mb-0">Valor Total Gasto</p>
                <small class="text-muted">Em manutenções</small>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-3">
        <div class="card h-100 border-0 shadow-sm metric-card">
            <div class="card-body text-center p-4">
                <div class="metric-icon mb-3">
                    <i class="fas fa-chart-line fa-3x text-warning"></i>
                </div>
                <h2 class="metric-value mb-2" id="media-mensal">R$ 0,00</h2>
                <p class="metric-label mb-0">Média Mensal</p>
                <small class="text-muted">Gastos por mês</small>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-3">
        <div class="card h-100 border-0 shadow-sm metric-card">
            <div class="card-body text-center p-4">
                <div class="metric-icon mb-3">
                    <i class="fas fa-tachometer-alt fa-3x text-info"></i>
                </div>
                <h2 class="metric-value mb-2" id="km-percorridos">0 km</h2>
                <p class="metric-label mb-0">Km Percorridos</p>
                <small class="text-muted">No período</small>
            </div>
        </div>
    </div>
</div>

<!-- Gráficos Interativos -->
<div class="row mb-4">
    <div class="col-lg-8 mb-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light">
                <div class="d-flex align-items-center justify-content-between">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie text-primary me-2"></i>Gastos por Tipo
                    </h5>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-cog me-1"></i>Opções
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="exportarGrafico('gastosTipo')">
                                <i class="fas fa-download me-1"></i>Exportar PNG
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="toggleGrafico('gastosTipo')">
                                <i class="fas fa-expand me-1"></i>Expandir
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <canvas id="gastosPorTipoChart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>

    <div class="col-lg-4 mb-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i class="fas fa-trophy text-warning me-2"></i>Top 5 Gastos
                </h5>
            </div>
            <div class="card-body">
                <div id="topGastos" class="list-group list-group-flush">
                    <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                        <div>
                            <i class="fas fa-oil-can text-primary me-2"></i>
                            <span>Óleo e Filtros</span>
                        </div>
                        <span class="badge bg-primary rounded-pill">R$ 450,00</span>
                    </div>
                    <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                        <div>
                            <i class="fas fa-bolt text-warning me-2"></i>
                            <span>Bateria</span>
                        </div>
                        <span class="badge bg-warning rounded-pill">R$ 320,00</span>
                    </div>
                    <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                        <div>
                            <i class="fas fa-cog text-success me-2"></i>
                            <span>Peças</span>
                        </div>
                        <span class="badge bg-success rounded-pill">R$ 280,00</span>
                    </div>
                    <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                        <div>
                            <i class="fas fa-tools text-info me-2"></i>
                            <span>Mão de Obra</span>
                        </div>
                        <span class="badge bg-info rounded-pill">R$ 200,00</span>
                    </div>
                    <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                        <div>
                            <i class="fas fa-gas-pump text-danger me-2"></i>
                            <span>Combustível</span>
                        </div>
                        <span class="badge bg-danger rounded-pill">R$ 150,00</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Gráfico de Tendência -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light">
                <div class="d-flex align-items-center justify-content-between">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line text-success me-2"></i>Tendência de Gastos
                    </h5>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-secondary active" onclick="alterarPeriodo('mensal')">
                            <i class="fas fa-calendar-week me-1"></i>Mensal
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="alterarPeriodo('trimestral')">
                            <i class="fas fa-calendar-alt me-1"></i>Trimestral
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="alterarPeriodo('anual')">
                            <i class="fas fa-calendar me-1"></i>Anual
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <canvas id="gastosPorMesChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Tabela Detalhada -->
<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light">
                <div class="d-flex align-items-center justify-content-between">
                    <h5 class="mb-0">
                        <i class="fas fa-table text-info me-2"></i>Detalhes das Manutenções
                    </h5>
                    <div class="input-group" style="width: 300px;">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" class="form-control" id="searchTable" placeholder="Buscar...">
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="tabela-manutenções">
                        <thead class="table-light">
                            <tr>
                                <th>
                                    <i class="fas fa-calendar me-1"></i>Data
                                </th>
                                <th>
                                    <i class="fas fa-motorcycle me-1"></i>Moto
                                </th>
                                <th>
                                    <i class="fas fa-wrench me-1"></i>Tipo
                                </th>
                                <th>
                                    <i class="fas fa-sticky-note me-1"></i>Descrição
                                </th>
                                <th>
                                    <i class="fas fa-dollar-sign me-1"></i>Valor
                                </th>
                                <th>
                                    <i class="fas fa-info-circle me-1"></i>Status
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" class="text-center py-5">
                                    <div class="empty-state">
                                        <i class="fas fa-info-circle fa-3x text-muted mb-3"></i>
                                        <h5 class="text-muted">Nenhum dado encontrado</h5>
                                        <p class="text-muted">Selecione um período para visualizar os dados</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer bg-light">
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                        Mostrando <span id="registros-visiveis">0</span> de <span id="total-registros">0</span> registros
                    </small>
                    <nav aria-label="Paginação da tabela">
                        <ul class="pagination pagination-sm mb-0" id="paginacao-tabela">
                            <li class="page-item disabled">
                                <a class="page-link" href="#">
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                            </li>
                            <li class="page-item active">
                                <a class="page-link" href="#">1</a>
                            </li>
                            <li class="page-item disabled">
                                <a class="page-link" href="#">
                                    <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let gastosPorTipoChart;
let gastosPorMesChart;
let dadosOriginais = {};

// Inicializar tudo quando a página carregar
document.addEventListener('DOMContentLoaded', function() {
    inicializarGraficos();
    configurarBusca();
    carregarDados();
});

// Inicializar gráficos
function inicializarGraficos() {
    // Gráfico de Gastos por Tipo
    const ctxTipo = document.getElementById('gastosPorTipoChart').getContext('2d');
    gastosPorTipoChart = new Chart(ctxTipo, {
        type: 'doughnut',
        data: {
            labels: ['Óleo e Filtros', 'Bateria', 'Peças', 'Mão de Obra', 'Combustível', 'Outros'],
            datasets: [{
                data: [450, 320, 280, 200, 150, 100],
                backgroundColor: [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return context.label + ': R$ ' + context.parsed.toLocaleString('pt-BR') + ' (' + percentage + '%)';
                        }
                    }
                }
            }
        }
    });

    // Gráfico de Gastos por Mês
    const ctxMes = document.getElementById('gastosPorMesChart').getContext('2d');
    gastosPorMesChart = new Chart(ctxMes, {
        type: 'line',
        data: {
            labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'],
            datasets: [{
                label: 'Gastos (R$)',
                data: [1200, 800, 1500, 900, 1100, 1300, 1000, 1400, 1200, 1600, 1100, 1300],
                borderColor: '#36A2EB',
                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#36A2EB',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 6,
                pointHoverRadius: 8
            }]
        },
        options: {
            responsive: true,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'R$ ' + context.parsed.y.toLocaleString('pt-BR');
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'R$ ' + value.toLocaleString('pt-BR');
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                }
            }
        }
    });
}

// Carregar dados da API
function carregarDados() {
    fetch('{% url "dashboard:api_data" %}')
        .then(response => response.json())
        .then(data => {
            atualizarMetricas(data);
            dadosOriginais = data;
        })
        .catch(error => console.error('Erro ao carregar dados:', error));
}

// Atualizar métricas
function atualizarMetricas(data) {
    if (data.metricas) {
        animateNumber('total-manutencoes', data.metricas.total_manutencoes || 0);
        animateNumber('total-gasto', (data.metricas.total_gasto || 0), 'R$ ');
        animateNumber('media-mensal', ((data.metricas.total_gasto || 0) / 12), 'R$ ');
        animateNumber('km-percorridos', 0, ' km');
    }
}

// Animação de números
function animateNumber(elementId, targetValue, prefix = '', suffix = '') {
    const element = document.getElementById(elementId);
    if (!element) return;

    const startValue = 0;
    const duration = 1000;
    const startTime = performance.now();

    function update(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);

        const currentValue = startValue + (targetValue - startValue) * progress;

        if (typeof targetValue === 'number' && targetValue % 1 !== 0) {
            element.textContent = prefix + currentValue.toLocaleString('pt-BR', {minimumFractionDigits: 2}) + suffix;
        } else {
            element.textContent = prefix + Math.floor(currentValue) + suffix;
        }

        if (progress < 1) {
            requestAnimationFrame(update);
        }
    }

    requestAnimationFrame(update);
}

// Configurar busca na tabela
function configurarBusca() {
    const searchInput = document.getElementById('searchTable');
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const rows = document.querySelectorAll('#tabela-manutenções tbody tr');

        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            if (text.includes(searchTerm)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });
}

// Funções de controle
function aplicarFiltros() {
    // Implementar filtros
    console.log('Aplicando filtros...');
    // Aqui seria implementada a lógica de filtros
}

function limparFiltros() {
    document.getElementById('data_inicio').value = '';
    document.getElementById('data_fim').value = '';
    document.getElementById('moto').value = '';
    document.getElementById('tipo_relatorio').value = 'geral';
}

function alterarPeriodo(periodo) {
    // Implementar mudança de período
    console.log('Alterando período para:', periodo);
}

function exportarPDF() {
    alert('Funcionalidade de exportação PDF será implementada em breve.');
}

function exportarGrafico(graficoId) {
    const canvas = document.getElementById(graficoId + 'Chart');
    const link = document.createElement('a');
    link.download = graficoId + '.png';
    link.href = canvas.toDataURL();
    link.click();
}

function toggleGrafico(graficoId) {
    const canvas = document.getElementById(graficoId + 'Chart');
    const container = canvas.parentElement;

    if (container.style.height === '600px') {
        container.style.height = '300px';
    } else {
        container.style.height = '600px';
    }

    // Re-renderizar gráfico
    setTimeout(() => {
        if (graficoId === 'gastosTipo') {
            gastosPorTipoChart.resize();
        } else {
            gastosPorMesChart.resize();
        }
    }, 300);
}
</script>

<style>
.metric-card {
    transition: all 0.3s ease;
    cursor: pointer;
}

.metric-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15) !important;
}

.metric-icon {
    transition: all 0.3s ease;
}

.metric-card:hover .metric-icon {
    transform: scale(1.1);
}

.metric-value {
    font-size: 2rem;
    font-weight: 700;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.metric-label {
    font-weight: 600;
    color: #6c757d;
}

.table th {
    font-weight: 600;
    color: #495057;
    border-bottom: 2px solid #dee2e6;
}

.table td {
    vertical-align: middle;
}

.empty-state {
    padding: 3rem 0;
}

.list-group-item {
    border: none;
    padding: 0.75rem 0;
}

.dropdown-menu {
    border: none;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
}

.btn-group .btn {
    border-radius: 6px !important;
}

.btn-group .btn:not(:last-child) {
    border-top-right-radius: 0 !important;
    border-bottom-right-radius: 0 !important;
}

.btn-group .btn:not(:first-child) {
    border-top-left-radius: 0 !important;
    border-bottom-left-radius: 0 !important;
}

@media (max-width: 768px) {
    .metric-value {
        font-size: 1.5rem;
    }

    .btn-group {
        flex-direction: column;
    }

    .btn-group .btn {
        border-radius: 6px !important;
        margin-bottom: 0.25rem;
    }
}
</style>
{% endblock %}
